log_collector:
  decoder:
    cinder:
      engine: sandbox
      module_file: /usr/share/lma_collector/decoders/openstack_log.lua
      module_dir: /usr/share/lma_collector/common;/usr/share/heka/lua_modules
      adjust_timezone: true
  splitter:
    cinder:
      engine: token
      delimiter: '\n'
  input:
    cinder_log:
      engine: logstreamer
      log_directory: "/var/log"
      file_match: 'cinder/(?P<Service>.+)\.log\.?(?P<Seq>\d*)$'
      differentiator: ['cinder', '_', 'Service']
      priority: ["^Seq"]
      decoder: "cinder_decoder"
      splitter: "cinder_splitter"
metric_collector:
  trigger:
    cinder_log_error_count:
      description: 'Too many errors have been detected in Cinder logs.'
      severity: warning
      no_data_policy: okay
      rules:
      - metric: log_messages
        dimension:
          service: cinder
          level: error
        relational_operator: '>'
        threshold: 0.1
        window: 70
        periods: 0
        function: max
    cinder_api_local_endpoint:
      description: 'Cinder API is locally down.'
      severity: down
      rules:
      - metric: openstack_check_local_api
        dimension:
          service: cinder-api
        relational_operator: '=='
        threshold: 0
        window: 60
        periods: 0
        function: last
  alarm:
    cinder_log_error_count:
      enable_notification: False
      activate_alerting: True
      triggers:
      - cinder_log_error_count
      dimension:
        service: cinder-control
    cinder_api_local_endpoint:
      enable_notification: False
      activate_alerting: True
      triggers:
      - cinder_api_local_endpoint
      dimension:
        service: cinder-control
remote_collector:
  trigger:
    cinder_api_remote_endpoint:
      description: 'Cinder API is down.'
      severity: down
      rules:
      - metric: openstack_check_api
        dimension:
          service: cinder-api
        relational_operator: '=='
        threshold: 0
        window: 60
        periods: 0
        function: last
    cinder_openstack_scheduler_one_down:
      description: 'At least one Cinder scheduler is down.'
      severity: warning
      rules:
      - metric: openstack_cinder_services
        domain:
          service: scheduler
          state: down
        relational_operator: '>'
        threshold: 0
        window: 60
        periods: 0
        function: last
    cinder_openstack_scheduler_majority_down:
      description: 'Majority of Cinder schedulers are down.'
      severity: critical
      rules:
      - metric: openstack_cinder_services
        domain:
          service: scheduler
          state: up
        relational_operator: '<='
        threshold: 50
        window: 60
        periods: 0
        function: last
    cinder_openstack_scheduler_all_down:
      description: 'All Cinder schedulers are down.'
      severity: down
      no_data_policy: skip
      rules:
      - metric: openstack_cinder_services
        domain:
          service: scheduler
          state: up
        relational_operator: '=='
        threshold: 0
        window: 60
        periods: 0
        function: last
    cinder_openstack_volume_one_down:
      description: 'At least one Cinder volume is down.'
      severity: warning
      rules:
      - metric: openstack_cinder_services
        domain:
          service: scheduler
          state: down
        relational_operator: '>'
        threshold: 0
        window: 60
        periods: 0
        function: last
    cinder_openstack_volume_majority_down:
      description: 'Majority of Cinder volumes are down.'
      severity: critical
      rules:
      - metric: openstack_cinder_services
        domain:
          service: volume
          state: up
        relational_operator: '<='
        threshold: 50
        window: 60
        periods: 0
        function: last
    cinder_openstack_volume_all_down:
      description: 'All Cinder volumes are down.'
      severity: down
      no_data_policy: skip
      rules:
      - metric: openstack_cinder_services
        domain:
          service: volume
          state: up
        relational_operator: '=='
        threshold: 0
        window: 60
        periods: 0
        function: last
  alarm:
    cinder_api_remote_endpoint:
      enable_notification: False
      activate_alerting: True
      triggers:
      - cinder_api_remote_endpoint
      dimension:
        service: cinder-control
    cinder_openstack_volume:
      enable_notification: False
      activate_alerting: True
      triggers:
      - cinder_openstack_volume_one_down
      - cinder_openstack_volume_majority_down
      - cinder_openstack_volume_all_down
      dimension:
        service: cinder-control
    cinder_openstack_scheduler:
      enable_notification: False
      activate_alerting: True
      triggers:
      - cinder_openstack_scheduler_one_down
      - cinder_openstack_scheduler_majority_down
      - cinder_openstack_scheduler_all_down
      dimension:
        service: cinder-control
